version: '3.8'

services:
  # üì¶ TU BOT DE INVENTARIO
  inventory_bot:
    build: .
    container_name: inventory_saas
    restart: always
    env_file: .env
    volumes:
      # ‚ö†Ô∏è IMPORTANTE: Sube estos archivos desde tu PC al servidor
      # El token.json es vital porque contiene tu sesi√≥n de Google activa
      - ./client_secret.json:/app/client_secret.json
      - ./token.json:/app/token.json
    networks:
      - proxy # Red p√∫blica de Traefik
      # - internal # Descomenta si necesitas conectar con una base de datos interna en el futuro
    labels:
      - "traefik.enable=true"
      
      # --- CONFIGURACI√ìN DE RUTA ---
      # Todo lo que empiece por /inventory ir√° a este contenedor
      # Tu URL quedar√°: https://n8n.srv1153123.hstgr.cloud/inventory/webhook/telegram
      - "traefik.http.routers.inventory-bot.rule=Host(`n8n.srv1153123.hstgr.cloud`) && PathPrefix(`/inventory`)"
      - "traefik.http.routers.inventory-bot.entrypoints=websecure"
      - "traefik.http.routers.inventory-bot.tls=true"
      - "traefik.http.routers.inventory-bot.tls.certresolver=mytlschallenge"
      
      # --- PUERTO ---
      # FastAPI corre en el 8000 internamente
      - "traefik.http.services.inventory-bot.loadbalancer.server.port=8000"
      
      # --- MIDDLEWARE (STRIP PREFIX) ---
      # Le quitamos el "/inventory" antes de pasarlo a Python, para que FastAPI lea "/webhook/telegram"
      - "traefik.http.middlewares.inventory-strip.stripprefix.prefixes=/inventory"
      - "traefik.http.routers.inventory-bot.middlewares=inventory-strip@docker"
      - "traefik.docker.network=proxy"

networks:
  proxy:
    external: true
  # internal: 
  #   external: true